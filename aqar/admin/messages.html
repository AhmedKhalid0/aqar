<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الرسائل | عقار</title>

    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/admin/css/admin.css" rel="stylesheet">
</head>

<body>
    <div id="sidebarContainer"></div>

    <main class="admin-main">
        <header class="admin-header">
            <button class="sidebar-toggle"><i class="bi bi-list"></i></button>
            <h1>الرسائل</h1>
            <span class="badge bg-warning" id="unreadBadge">0 غير مقروءة</span>
        </header>

        <div class="admin-content">
            <div class="row">
                <div class="col-lg-4">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3>صندوق الوارد</h3>
                        </div>
                        <div class="p-3 border-bottom">
                            <div class="d-flex gap-2 mb-2">
                                <select class="form-select form-select-sm" id="filterSubject">
                                    <option value="">جميع المواضيع</option>
                                    <option value="inquiry">استفسار عام</option>
                                    <option value="unit">استفسار وحدة</option>
                                    <option value="project">استفسار مشروع</option>
                                    <option value="partnership">شراكة</option>
                                    <option value="complaint">شكوى</option>
                                </select>
                                <select class="form-select form-select-sm" id="filterRead">
                                    <option value="">الكل</option>
                                    <option value="unread">غير مقروءة</option>
                                    <option value="read">مقروءة</option>
                                </select>
                            </div>
                            <input type="text" class="form-control form-control-sm" id="searchInput"
                                placeholder="بحث بالاسم أو البريد...">
                        </div>
                        <div class="data-card-body p-0" style="max-height: 500px; overflow-y: auto;" id="messagesList">
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="data-card" id="messageDetail" style="display: none;">
                        <div class="data-card-header">
                            <h3 id="messageSubject">الموضوع</h3>
                            <button class="btn btn-sm btn-outline-danger" id="deleteMessageBtn"><i
                                    class="bi bi-trash"></i></button>
                        </div>
                        <div class="p-4">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <strong id="messageSender">المرسل</strong>
                                    <br><small class="text-muted" id="messageEmail">البريد</small>
                                </div>
                                <small class="text-muted" id="messageDate">التاريخ</small>
                            </div>
                            <hr>
                            <p id="messagePhone" class="mb-2"><i class="bi bi-telephone me-2"></i></p>
                            <div id="messageContent" class="mt-4" style="white-space: pre-wrap;"></div>
                            <hr>
                            <div class="d-flex gap-2">
                                <a id="replyEmail" href="#" class="btn btn-gold"><i class="bi bi-reply me-2"></i>رد
                                    بالبريد</a>
                                <a id="replyWhatsapp" href="#" target="_blank" class="btn btn-success"><i
                                        class="bi bi-whatsapp me-2"></i>واتساب</a>
                            </div>
                        </div>
                    </div>
                    <div class="text-center py-5 text-muted" id="noMessageSelected">
                        <i class="bi bi-envelope-open fs-1 d-block mb-3"></i>
                        اختر رسالة لعرضها
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/js/admin.js"></script>
    <script>
        let messages = [];
        let currentMessageId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!await Admin.checkAuth()) return;
            Admin.initSidebar();
            loadMessages();
        });

        async function loadMessages() {
            try {
                const response = await Admin.adminFetch('/api/admin/messages');
                messages = response.data || response || [];
                messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                renderMessages();

                const unread = messages.filter(m => !m.read).length;
                document.getElementById('unreadBadge').textContent = `${unread} غير مقروءة`;

                // Setup filter listeners
                document.getElementById('filterSubject').addEventListener('change', applyFilters);
                document.getElementById('filterRead').addEventListener('change', applyFilters);
                document.getElementById('searchInput').addEventListener('input', applyFilters);
            } catch (error) {
                Admin.showAlert('فشل تحميل الرسائل', 'danger');
            }
        }

        function applyFilters() {
            const subject = document.getElementById('filterSubject').value;
            const readStatus = document.getElementById('filterRead').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            const filtered = messages.filter(msg => {
                if (subject && msg.subject !== subject) return false;
                if (readStatus === 'unread' && msg.read) return false;
                if (readStatus === 'read' && !msg.read) return false;
                if (search && !msg.name?.toLowerCase().includes(search) && !msg.email?.toLowerCase().includes(search)) return false;
                return true;
            });

            renderFilteredMessages(filtered);
        }

        function renderFilteredMessages(data) {
            const list = document.getElementById('messagesList');
            if (data.length === 0) {
                list.innerHTML = '<div class="text-center py-4 text-muted">لا توجد رسائل</div>';
                return;
            }

            list.innerHTML = data.map(msg => `
                <div class="p-3 border-bottom message-item ${!msg.read ? 'bg-light' : ''}" 
                     style="cursor: pointer;" onclick="viewMessage('${msg.id}')">
                    <div class="d-flex justify-content-between">
                        <strong class="${!msg.read ? 'text-navy' : 'text-muted'}">${msg.name}</strong>
                        <small class="text-muted">${Admin.formatDate(msg.createdAt).split(',')[0]}</small>
                    </div>
                    <div class="text-muted small text-truncate">${msg.subject || 'بدون موضوع'}</div>
                    ${!msg.read ? '<span class="badge bg-warning text-dark small">جديد</span>' : ''}
                </div>
            `).join('');
        }

        function renderMessages() {
            renderFilteredMessages(messages);
        }

        async function viewMessage(id) {
            const msg = messages.find(m => m.id === id);
            if (!msg) return;

            currentMessageId = id;

            document.getElementById('noMessageSelected').style.display = 'none';
            document.getElementById('messageDetail').style.display = 'block';

            document.getElementById('messageSubject').textContent = msg.subject || 'بدون موضوع';
            document.getElementById('messageSender').textContent = msg.name;
            document.getElementById('messageEmail').textContent = msg.email;
            document.getElementById('messagePhone').innerHTML = `<i class="bi bi-telephone me-2"></i>${msg.phone}`;
            document.getElementById('messageDate').textContent = Admin.formatDate(msg.createdAt);
            document.getElementById('messageContent').textContent = msg.message;

            document.getElementById('replyEmail').href = `mailto:${msg.email}?subject=Re: ${msg.subject || 'رسالة من عقار'}`;
            document.getElementById('replyWhatsapp').href = `https://wa.me/${msg.phone?.replace(/[^0-9]/g, '')}`;

            if (!msg.read) {
                try {
                    await Admin.adminFetch(`/api/admin/messages/${id}/read`, { method: 'PUT' });
                    msg.read = true;
                    renderMessages();
                    const unread = messages.filter(m => !m.read).length;
                    document.getElementById('unreadBadge').textContent = `${unread} غير مقروءة`;
                } catch (e) { }
            }
        }

        document.getElementById('deleteMessageBtn').addEventListener('click', async () => {
            if (!currentMessageId) return;
            if (!await Admin.confirmAction('هل أنت متأكد من حذف هذه الرسالة؟')) return;

            try {
                await Admin.adminFetch(`/api/admin/messages/${currentMessageId}`, { method: 'DELETE' });
                Admin.showAlert('تم حذف الرسالة');
                document.getElementById('messageDetail').style.display = 'none';
                document.getElementById('noMessageSelected').style.display = 'block';
                loadMessages();
            } catch (error) {
                Admin.showAlert('فشل الحذف', 'danger');
            }
        });
    </script>
</body>

</html>